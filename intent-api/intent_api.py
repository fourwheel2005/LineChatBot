from flask import Flask, request, jsonify
from pythainlp.tokenize import word_tokenize
import os

app = Flask(__name__)

# หมวด intent และ keyword
intent_keywords = {
    "contact": [
        "ติดต่อ", "เบอร์", "โทร", "ไลน์", "ช่องทาง", "ติดต่อได้ที่", "หมายเลข", "ติดต่อกลับ", "สอบถาม",
        "แอดไลน์", "แชท", "แอด", "ส่งข้อความ", "คุยกับแอดมิน", "ติดต่อแอด", "ติดต่อร้าน", "ทางไหน",
        "แชทหา", "line", "ช่องทางการติดต่อ", "แอดไลน์ได้ที่ไหน", "มีเบอร์มั้ย"
    ],
    "price": [
        "ราคา", "บาท", "เท่าไหร่", "เท่าไร", "คิดยังไง", "คิดราคา", "ค่าส่ง", "แพงไหม", "โปรโมชั่น", "ลด", "เรท",
        "เท่าไหร่คะ", "เท่าไหร่ครับ", "ราคาเท่าไหร่", "ราคารวม", "บอกราคา", "สอบถามราคา", "ราคาชิ้นนี้",
        "ค่าบริการ", "ขอราคาด้วย", "ราคาต่อชิ้น", "ราคาทั้งหมด", "ราคาส่ง", "ราคาโปรโมชั่น"
    ],
    "order": [
        "สั่งซื้อ", "สั่ง", "อยากได้", "จะซื้อ", "สนใจ", "สั่งของ", "ขอสั่ง", "ขอซื้อ", "รับสินค้า", "ต้องการ",
        "สั่งเลย", "ซื้อเลย", "จัดส่ง", "ขอใบเสนอราคา", "สั่งยังไง", "สั่งได้ที่ไหน", "มีของมั้ย", "มีไหม",
        "อยากสั่ง", "สั่งตรงไหน", "กดสั่ง", "สั่งด่วน", "ขอรายละเอียด", "มีขายมั้ย", "รับเลย",
        "สั่งเลยได้ไหม", "ซื้อยังไง", "ต้องทำไงถึงสั่งได้"
    ],
    "companyAdvantages": [
        "บริษัทมีดีอย่างไร", "จุดเด่นบริษัท", "ดีไหม", "น่าเชื่อถือไหม", "มั่นใจได้ไหม",
        "รีวิวบริษัท", "มีอะไรดี", "ข้อดีของบริษัท", "แนะนำบริษัท", "ทำไมถึงเลือกบริษัทนี้",
        "ข้อได้เปรียบ", "บริษัทนี้ดีกว่าที่อื่นยังไง", "คุณภาพ", "เชื่อถือได้ไหม", "ทำไมถึงดี",
        "เลือกบริษัทนี้ดีไหม", "มีความน่าเชื่อถือหรือไม่", "บริการดีไหม", "การบริการเป็นยังไง"
    ],
    "product": [
        "บริษัทนี้มีสินค้าอะไรบ้าง", "มีสินค้าอะไรบ้าง", "ขายอะไร", "มีขายอะไรบ้าง", "รายการสินค้า", "มีผลิตภัณฑ์อะไรบ้าง",
        "ขายสินค้าประเภทไหน", "สินค้า", "สินค้าอะไร", "ผลิตภัณฑ์", "ให้ดูสินค้าหน่อย", "ขอดูสินค้า"
    ],
    "payment": [
        "ชำระเงิน", "จ่ายเงิน", "โอนเงิน", "โอนยังไง", "จ่ายยังไง", "มีเก็บปลายทางไหม",
        "วิธีชำระ", "จ่ายผ่านอะไร", "โอนผ่านธนาคาร", "ช่องทางการโอน", "ต้องโอนก่อนไหม"
    ],
    "delivery": [
        "จัดส่ง", "ส่งของ", "ส่งยังไง", "ขนส่งอะไร", "ใช้ขนส่งอะไร",
        "กี่วันถึง", "ส่งนานไหม", "ขอเบอร์คนส่ง", "ติดตามของ", "ขนส่งไหน"
    ],
    "working_hours": [
        "เปิดกี่โมง", "เวลาทำการ", "เปิดวันไหน", "หยุดวันไหน",
        "ติดต่อได้เวลาไหน", "ตอบแชทกี่โมง", "เปิดทุกวันไหม", "ทำงานวันไหนบ้าง"
    ],
    "location": [
        "ที่อยู่", "ตั้งอยู่ที่", "อยู่จังหวัดอะไร", "ไปหน้าร้านได้ไหม",
        "มีหน้าร้านไหม", "แผนที่", "พิกัด", "ร้านอยู่ที่ไหน", "สามารถไปรับเองได้ไหม"
    ]






}

# Endpoint วิเคราะห์ intent
@app.route("/analyze", methods=["POST"])
def analyze():
    data = request.get_json(force=True)
    text = data.get("text", "").strip()

    if not text:
        return jsonify({"intent": "unknown"})

    tokens = word_tokenize(text, engine="newmm")
    print(f"Tokens: {tokens}")  # DEBUG

    for intent, keywords in intent_keywords.items():
        if any(word in tokens for word in keywords):
            return jsonify({"intent": intent})

    return jsonify({"intent": "unknown"})

# เพิ่ม /ping endpoint สำหรับ health check
@app.route("/ping", methods=["GET"])
def ping():
    return "OK", 200

# Run app
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
